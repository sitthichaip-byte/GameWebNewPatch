<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Monster Key (Definitive Final Version)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Noto+Sans+Thai:wght@400&display=swap" rel="stylesheet">
    <style>
        /* --- CSS Section --- */
        body {
            background-color: #1a1a2e;
            color: #e0e0e0;
            font-family: 'Noto Sans Thai', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            text-align: center;
            overflow: hidden;
        }
        #main-container {
            display: flex;
            align-items: flex-start;
            gap: 20px;
        }
        #game-container {
            width: 800px;
            height: 600px;
            background: rgba(23, 23, 39, 0.8);
            border: 2px solid #a486f2;
            border-radius: 15px;
            box-shadow: 0 0 25px rgba(164, 134, 242, 0.5);
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
        }
        #volume-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 10;
        }
        #volume-button {
            background: none;
            border: none;
            color: #fca311;
            font-size: 1.5em;
            cursor: pointer;
        }
        #volume-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100px;
            height: 8px;
            background: #555;
            outline: none;
            border-radius: 5px;
        }
        #volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #fca311;
            cursor: pointer;
            border-radius: 50%;
        }
        #leaderboard-container {
            width: 300px;
            background: rgba(23, 23, 39, 0.8);
            border: 2px solid #fca311;
            padding: 20px;
            border-radius: 15px;
            height: 560px;
        }
        #leaderboard-container h2 {
            font-family: 'Cinzel', serif;
            color: #fca311;
            margin-top: 0;
        }
        #leaderboard-list {
            list-style: none;
            padding: 0;
            text-align: left;
            max-height: 500px;
            overflow-y: auto;
        }
        #leaderboard-list li {
            background: rgba(255, 255, 255, 0.05);
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            font-size: 1.1em;
        }
        #game-stats {
            display: flex;
            justify-content: space-around;
            font-size: 1.2em;
        }
        #monster-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #monster-name {
            font-family: 'Cinzel', serif;
            font-weight: 900;
            font-size: 4em;
            color: #fca311;
            text-shadow: 0 0 10px #fca311, 0 0 20px #ff5722;
            height: auto;
            animation: glow 2s ease-in-out infinite alternate;
        }
        #health-bar-container {
            width: 80%;
            height: 25px;
            background-color: #333;
            border: 2px solid #fca311;
            border-radius: 15px;
            margin-top: 5px;
            overflow: hidden;
        }
        #health-bar {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #d32f2f, #ff4141);
            transition: width 0.5s ease-in-out;
        }
        #monster-image {
            max-height: 250px;
            margin-top: 15px;
            transition: transform 0.2s;
            animation: float 3s ease-in-out infinite;
        }
        #monster-image.hurt {
            animation: none;
            transform: scale(1.05);
            filter: brightness(1.5);
        }
        #word-to-type {
            font-size: 2.5em;
            letter-spacing: 5px;
            font-weight: bold;
            color: #ffffff;
            text-shadow: 0 0 15px #00e5ff;
            height: 60px;
        }
        #player-input {
            width: 80%;
            padding: 15px;
            font-size: 1.5em;
            text-align: center;
            background-color: rgba(255, 255, 255, 0.1);
            border: 2px solid #a486f2;
            border-radius: 10px;
            color: #ffffff;
            outline: none;
            margin: 20px auto;
        }
        #start-screen {
            height: 80px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #start-button {
            padding: 20px 40px;
            font-size: 2em;
            font-family: 'Cinzel', serif;
            color: #1a1a2e;
            background-color: #fca311;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 0 15px #fca311;
        }
        #start-button:hover {
            transform: scale(1.05);
        }
        .correct { color: #00ff7f; }
        .incorrect { color: #ff4141; }
        .hidden { display: none !important; }

        @keyframes glow {
            from { text-shadow: 0 0 10px #fca311, 0 0 20px #ff5722; }
            to { text-shadow: 0 0 20px #fca311, 0 0 30px #ff8c00; }
        }
        @keyframes float {
            0% { transform: translatey(0px); }
            50% { transform: translatey(-10px); }
            100% { transform: translatey(0px); }
        }
    </style>
</head>
<body>

    <div id="main-container">
        <div id="game-container">
            <div id="volume-controls">
                <button id="volume-button"><i class="fas fa-volume-up"></i></button>
                <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="0.3">
            </div>
            <div id="game-stats" class="hidden">
                <div>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: <span id="score">0</span></div>
                <div>‡πÄ‡∏ß‡∏•‡∏≤: <span id="timer">0</span></div>
            </div>
            <div id="monster-area">
                <h2 id="monster-name">Monster Key</h2>
                <div id="health-bar-container" class="hidden">
                    <div id="health-bar"></div>
                </div>
                <img id="monster-image" src="https://i.postimg.cc/C5j6rV86/Chat-GPT-Image-15-2568-01-32-17.png" alt="Monster">
            </div>
            <div id="word-to-type"></div>
            <input type="text" id="player-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≤‡∏ñ‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..." autocomplete="off" disabled>
            <div id="start-screen">
                <button id="start-button">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</button>
            </div>
        </div>
        <div id="leaderboard-container">
             <h2>üèÜ Leaderboard üèÜ</h2>
            <ul id="leaderboard-list">
                <li>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</li>
            </ul>
        </div>
    </div>
    
    <audio id="background-music" src="file:///C:/Users/tykun/Downloads/assets_Untitled%20design%20(1).mp3" loop></audio>
    <audio id="typing-sound" src="file:///C:/Users/tykun/Downloads/download.mp3" preload="auto"></audio>
    <audio id="correct-word-sound" src="file:///C:/Users/tykun/Downloads/download%20(2).mp3" preload="auto"></audio>

    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

    <script>
        // --- 1. ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ ---
        
        const firebaseConfig = {
          apiKey: "AIzaSyBUBIEQLU2OHw_1ataX1di6V86s0qPsr_E",
          authDomain: "typomancer-game.firebaseapp.com",
          projectId: "typomancer-game",
          storageBucket: "typomancer-game.appspot.com",
          messagingSenderId: "988104502180",
          appId: "1:988104502180:web:62dd3b80869a131b39ef31"
        };
    
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        const monsterDatabase = [
            { 
                name: "Black Monster",
                imageUrl: "https://i.postimg.cc/8zLsyfJp/monster-horror.gif",
                words: ["aqua", "bubble", "splash", "whip"],
                baseHealth: 1
            },
            { 
                name: "Godzilla",
                imageUrl: "https://i.postimg.cc/L8MYz3C4/tumblr-b560de8aa57e477d5fc6eb7e356a8e86-ef0e9259-1280.webp",
                words: ["atomic", "crush", "stomp", "radioactive"],
                baseHealth: 2
            },
            {
                name: "J√∂rmungandr",
                imageUrl: "https://i.postimg.cc/SKS44nsf/tumblr-pysire-Cw-Ur1y172yjo3-400.webp",
                words: ["midgard", "venom", "ragnarok", "world-eater"],
                baseHealth: 3
            }
        ];
        
        const gameStats = document.getElementById('game-stats');
        const scoreDisplay = document.getElementById('score');
        const timerDisplay = document.getElementById('timer');
        const monsterImage = document.getElementById('monster-image');
        const monsterName = document.getElementById('monster-name');
        const wordToType = document.getElementById('word-to-type');
        const playerInput = document.getElementById('player-input');
        const startButton = document.getElementById('start-button');
        const leaderboardList = document.getElementById('leaderboard-list');
        const healthBarContainer = document.getElementById('health-bar-container');
        const healthBar = document.getElementById('health-bar');
        const backgroundMusic = document.getElementById('background-music');
        const typingSound = document.getElementById('typing-sound');
        const correctWordSound = document.getElementById('correct-word-sound');
        const volumeButton = document.getElementById('volume-button');
        const volumeSlider = document.getElementById('volume-slider');
    
        let gameLevel = 0;
        let score = 0, timer, timeLeft = 15, currentWord = '', isPlaying = false;
        let availableMonsters = [];
        let currentMonsterHealth = 0;
        let currentMonsterMaxHealth = 0;
        let currentMonsterObject = null;

        // --- 2. ‡πÇ‡∏´‡∏°‡∏î PvP ---
        const socket = io("https://gamennetservet.onrender.com");
        let myRoom = '';

        socket.on('connect_error', () => {
            console.log("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå PvP ‡πÑ‡∏î‡πâ, ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß");
        });
        
        socket.on('waiting', (message) => { 
            monsterName.textContent = message; 
            monsterImage.classList.add('hidden'); 
        });
        socket.on('gameStart', (players) => {
            gameStats.classList.remove('hidden');
            monsterImage.classList.add('hidden');
            healthBarContainer.classList.add('hidden');
            playerInput.classList.remove('hidden');
            playerInput.disabled = false;
            playerInput.focus();
            myRoom = `room-${players.p1}-${players.p2}`;
        });
        socket.on('newWord', (word) => {
            currentWord = word;
            wordToType.innerHTML = currentWord.split('').map(char => `<span>${char}</span>`).join('');
            playerInput.value = '';
            monsterName.textContent = "‡πÅ‡∏Ç‡πà‡∏á‡∏Å‡∏±‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå!";
            monsterName.style.animation = 'none';
        });
        socket.on('opponentFinished', () => { alert("‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏ô‡∏∞‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ!"); });

        // --- 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡∏° ---
        function setupInitialScreen() {
            monsterImage.classList.remove('hidden');
            monsterImage.style.animation = 'float 3s ease-in-out infinite';
            healthBarContainer.classList.add('hidden');
            gameStats.classList.add('hidden');
            monsterName.textContent = "Monster Key";
            monsterName.style.animation = 'glow 2s ease-in-out infinite alternate';
            monsterName.style.fontSize = '4em';
            wordToType.innerHTML = "";
            playerInput.value = "";
            playerInput.disabled = true;
            startButton.style.display = 'block';
            startButton.textContent = '‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°';
            playerInput.classList.add('hidden');
        }
        
        function startGame() { 
            isPlaying = true; 
            myRoom = ''; 
            backgroundMusic.volume = volumeSlider.value;
            backgroundMusic.play();
            startButton.style.display = 'none'; 
            playerInput.disabled = false; 
            playerInput.classList.remove('hidden');
            score = 0; 
            scoreDisplay.textContent = score; 
            availableMonsters = [...monsterDatabase];
            gameLevel = 0;
            monsterImage.classList.remove('hidden');
            healthBarContainer.classList.remove('hidden');
            gameStats.classList.remove('hidden');
            newRound(); 
        }
        
        function newRound() {
            if (availableMonsters.length === 0) {
                availableMonsters = [...monsterDatabase];
            }
            const randomIndex = Math.floor(Math.random() * availableMonsters.length);
            currentMonsterObject = availableMonsters[randomIndex];
            availableMonsters.splice(randomIndex, 1);
            
            const healthBonus = Math.floor(gameLevel / 2);
            currentMonsterMaxHealth = currentMonsterObject.baseHealth + healthBonus;
            currentMonsterHealth = currentMonsterMaxHealth;
            
            updateHealthBar();

            monsterImage.src = currentMonsterObject.imageUrl;
            monsterImage.style.animation = 'none';
            monsterName.textContent = currentMonsterObject.name;
            monsterName.style.animation = 'none';
            monsterName.style.fontSize = '2em';
            
            getNewWord();
            
            clearInterval(timer);
            timeLeft = 15;
            timerDisplay.textContent = timeLeft;
            timer = setInterval(updateTimer, 1000);
            playerInput.focus();
        }

        function getNewWord() {
            playerInput.value = '';
            const newWordIndex = Math.floor(Math.random() * currentMonsterObject.words.length);
            currentWord = currentMonsterObject.words[newWordIndex];
            wordToType.innerHTML = currentWord.split('').map(char => `<span>${char}</span>`).join('');
        }

        function updateHealthBar() {
            const healthPercent = (currentMonsterHealth / currentMonsterMaxHealth) * 100;
            healthBar.style.width = `${healthPercent}%`;
        }

        function checkInput() {
            if (typingSound) {
                typingSound.currentTime = 0;
                typingSound.play();
            }
            const typedText = playerInput.value;
            const wordChars = wordToType.querySelectorAll('span');
            let isCorrect = true;

            wordChars.forEach((charSpan, index) => {
                if (typedText[index] == null) {
                    charSpan.className = ''; isCorrect = false;
                } else if (typedText[index] === charSpan.textContent) {
                    charSpan.className = 'correct';
                } else {
                    charSpan.className = 'incorrect'; isCorrect = false;
                }
            });

            if (isCorrect && typedText.length > 0 && typedText === currentWord) {
                if(correctWordSound) {
                    correctWordSound.currentTime = 0;
                    correctWordSound.play();
                }

                if (myRoom) {
                    socket.emit('wordTyped', { room: myRoom });
                    return;
                }

                score += currentWord.length;
                scoreDisplay.textContent = score;
                monsterImage.classList.add('hurt');
                setTimeout(() => monsterImage.classList.remove('hurt'), 200);
                currentMonsterHealth--;
                updateHealthBar();

                if (currentMonsterHealth <= 0) {
                    gameLevel++;
                    setTimeout(newRound, 500);
                } else {
                    getNewWord();
                }
            }
        }

        function updateTimer() {
            timeLeft--;
            timerDisplay.textContent = timeLeft;
            if (timeLeft <= 0) {
                gameOver();
            }
        }
    
        async function gameOver() {
            isPlaying = false;
            clearInterval(timer);
            backgroundMusic.pause();
            backgroundMusic.currentTime = 0;
            
            setupInitialScreen();
            monsterName.textContent = "‡∏à‡∏ö‡πÄ‡∏Å‡∏°!";
            wordToType.innerHTML = `<span style="font-size: 0.8em;">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢: ${score}</span>`;
            
            if (score > 0) {
                const playerName = prompt("‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î! ‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Leaderboard:", "Player");
                if (playerName) { await saveScore(playerName, score); }
            }
            
            startButton.textContent = '‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
            await displayLeaderboard();
        }

        // --- 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Leaderboard (Firebase) ---
        async function saveScore(name, scoreValue) {
            try {
                await db.collection("leaderboard").add({
                    name: name,
                    score: scoreValue,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ", error);
            }
        }
    
        async function displayLeaderboard() {
            leaderboardList.innerHTML = '<li>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</li>';
            try {
                const snapshot = await db.collection("leaderboard")
                                         .orderBy("score", "desc")
                                         .limit(10)
                                         .get();
                
                leaderboardList.innerHTML = '';
                if (snapshot.empty) {
                    leaderboardList.innerHTML = '<li>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</li>';
                    return;
                }
    
                let rank = 1;
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const li = document.createElement('li');
                    li.innerHTML = `<span>#${rank} ${data.name}</span><span>${data.score}</span>`;
                    leaderboardList.appendChild(li);
                    rank++;
                });
    
            } catch (error) {
                console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ", error);
                leaderboardList.innerHTML = '<li>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</li>';
            }
        }
    
        // --- 5. ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ---
        
        // Event Listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏á
        volumeButton.addEventListener('click', () => {
            backgroundMusic.muted = !backgroundMusic.muted;
            if (backgroundMusic.muted) {
                volumeButton.innerHTML = '<i class="fas fa-volume-mute"></i>';
                volumeSlider.disabled = true;
            } else {
                volumeButton.innerHTML = '<i class="fas fa-volume-up"></i>';
                volumeSlider.disabled = false;
            }
        });

        volumeSlider.addEventListener('input', (e) => {
            const volume = e.target.value;
            backgroundMusic.volume = volume;
            if (volume > 0 && backgroundMusic.muted) {
                backgroundMusic.muted = false;
                volumeButton.innerHTML = '<i class="fas fa-volume-up"></i>';
                volumeSlider.disabled = false;
            } else if (volume == 0) {
                 backgroundMusic.muted = true;
                volumeButton.innerHTML = '<i class="fas fa-volume-mute"></i>';
            }
        });
        
        // Event Listeners ‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡∏°
        startButton.addEventListener('click', startGame);
        playerInput.addEventListener('input', checkInput);
        
        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
        setupInitialScreen();
        displayLeaderboard();
    
    </script>

</body>
</html>

